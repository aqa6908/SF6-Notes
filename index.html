<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAog6i-mDornqBzLI-81aeXhS_2eP6kx-A",
      authDomain: "sf6-notes.firebaseapp.com",
      projectId: "sf6-notes",
      storageBucket: "sf6-notes.firebasestorage.app",
      messagingSenderId: "832506018972",
      appId: "1:832506018972:web:428aaef84a1aa802d40159",
      measurementId: "G-39RZ6VTXZ7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== 狀態 =====
    let currentCharacter = ""; 
    let allNotes = [];
    let currentSteps = [];
    let characters = [
        "A.K.I.", "BLANKA", "C.VIPER", "CAMMY", "CHUN-LI", 
        "DEE JAY", "DHALSIM", "E.HONDA", "ED", "ELENA", 
        "GOUKI", "GUILE", "JAMIE", "JP", "JURI", 
        "KEN", "KIMBERLY", "LILY", "LUKE", "MAI", 
        "MANON", "MARISA", "RASHID", "RYU", "TERRY", 
        "VEGA", "ZANGIEF"
    ];
    characters.sort();

    // ===== DOM 抓一次即可（script 在 body 最後） =====
    const previewDiv = document.getElementById('comboPreview');
    const stepInput  = document.getElementById('stepInput');
    const saveBtn    = document.getElementById('saveBtn');

    // ===== UI 函式 =====
    function renderCharGrid(list) {
        const grid = document.getElementById('charGrid');
        grid.innerHTML = list.map(name => `
            <div class="char-btn" onclick="selectCharacter('${name}')">
                <span class="char-name-display">${name}</span>
            </div>
        `).join('');
    }

    function renderPreview() {
        if (currentSteps.length === 0) {
            previewDiv.innerHTML = '<span class="text-zinc-500 text-sm">輸入指令按 Enter...</span>';
            return;
        }
        previewDiv.innerHTML = currentSteps.map((step, idx) => {
            let style = "bg-zinc-700";
            if (['DR', 'PC', 'DI', 'OD'].includes(step)) style = "bg-green-900 text-green-300 border border-green-700";
            else if (step.includes('SA')) style = "bg-red-900 text-red-200 border border-red-700";
            return `<span class="input-block ${style}">${step}</span>` + (idx < currentSteps.length-1 ? `<span class="step-arrow">➜</span>` : '');
        }).join('');
    }

    function renderNotes() {
        const list = document.getElementById('cardList');
        const emptyState = document.getElementById('emptyState'); // 防 null

        const charNotes = allNotes.filter(n => n.char === currentCharacter);
        
        if (charNotes.length === 0) {
            list.innerHTML = ""; 
            if (emptyState) emptyState.classList.remove('hidden');
            return;
        }
        if (emptyState) emptyState.classList.add('hidden');

        list.innerHTML = [...charNotes].reverse().map(note => {
            let typeLabel = "連段", typeColor = "text-blue-200 border-blue-700 bg-blue-900/50";
            if(note.type === 'punish') { typeLabel = "確反"; typeColor = "text-red-200 border-red-700 bg-red-900/50"; }
            if(note.type === 'setup') { typeLabel = "詐欺跳"; typeColor = "text-yellow-200 border-yellow-700 bg-yellow-900/50"; }

            let flowHtml = note.steps.map((step, idx) => {
                let style = "bg-zinc-700 px-1 rounded";
                if (['DR', 'PC', 'DI', 'OD'].includes(step)) style = "text-green-400 font-bold";
                else if (step.includes('SA')) style = "text-red-400 font-bold";
                return `<span class="${style}">${step}</span>` + (idx < note.steps.length-1 ? `<span class="step-arrow">➜</span>` : '');
            }).join('');

            return `
                <div class="card-preview group" onclick="openFocus(${note.id})">
                    <div class="delete-btn" onclick="deleteCard(event, ${note.id})">×</div>
                    <div class="flex justify-between items-start mb-2">
                        <span class="${typeColor} text-xs px-2 py-0.5 rounded border font-bold">${typeLabel}</span>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">Damage</div>
                            <div class="text-xl font-bold text-white leading-none mono-font">${note.dmg}</div>
                        </div>
                    </div>
                    <div class="text-base mono-font text-gray-300 truncate">${flowHtml}</div>
                </div>
            `;
        }).join('');
    }

    async function loadNotesFromCloud() {
        allNotes = [];
        const q = query(collection(db, "notes"), where("char", "==", currentCharacter));
        const snap = await getDocs(q);
        snap.forEach(docSnap => {
            const data = docSnap.data();
            allNotes.push({
                id: data.id,
                docId: docSnap.id,
                ...data
            });
        });
        renderNotes();
    }

    async function saveCardToCloud(noteObj) {
        const docRef = await addDoc(collection(db, "notes"), noteObj);
        return docRef.id;
    }

    // ===== 全域函式（HTML onclick 用） =====
    window.selectCharacter = async function(name) {
        currentCharacter = name;
        document.getElementById('charSelectScreen').classList.add('hidden');
        document.getElementById('contentScreen').classList.remove('hidden');
        document.getElementById('navBar').classList.remove('hidden');
        document.getElementById('navTitle').innerText = name;
        await loadNotesFromCloud();
    };

    window.goBackToSelect = function() {
        document.getElementById('contentScreen').classList.add('hidden');
        document.getElementById('navBar').classList.add('hidden');
        document.getElementById('charSelectScreen').classList.remove('hidden');
        document.getElementById('builderSection').classList.add('hidden');
        document.getElementById('addBtn').classList.remove('hidden');
    };

    window.openFocus = function(id) {
        const note = allNotes.find(n => n.id === id);
        if (!note) return;

        const overlay = document.getElementById('focusOverlay');
        const main = document.getElementById('focusMainContent');
        const tree = document.getElementById('focusTreeContent');
        
        let driveHtml = '';
        for(let i=0; i<6; i++) driveHtml += `<span class="drive-box ${i < note.drive ? 'drive-on' : 'drive-off'}"></span>`;
        
        let flowHtml = note.steps.map((step, idx) => {
            let style = "bg-zinc-700 px-3 py-1 rounded mx-1 text-3xl"; 
            if (['DR', 'PC', 'DI', 'OD'].includes(step)) style = "text-green-400 font-bold text-3xl mx-1";
            else if (step.includes('SA')) style = "text-red-400 font-bold text-3xl mx-1";
            return `<span class="${style} inline-block mb-3">${step}</span>` + (idx < note.steps.length-1 ? `<span class="step-arrow text-3xl">➜</span>` : '');
        }).join('');

        main.innerHTML = `
            <div class="flex justify-between items-end border-b border-gray-700 pb-4 mb-6">
                <div>
                    <div class="text-sm text-gray-400 mb-1">DRIVE COST</div>
                    <div>${driveHtml}</div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-400">DAMAGE</div>
                    <div class="text-5xl font-bold text-white mono-font">${note.dmg}</div>
                </div>
            </div>
            <div class="text-white mono-font leading-relaxed mb-6 text-xl">${flowHtml}</div>
            <div class="flex items-center gap-3">
                <span class="bg-blue-900/30 text-blue-400 border border-blue-900 px-4 py-2 rounded font-bold mono-font text-2xl">+${note.frame}F</span>
                <span class="text-gray-500 text-sm tracking-widest">ADVANTAGE</span>
            </div>
        `;

        const okiLines = note.okiRaw.split('\n').filter(l => l.trim() !== "");
        if (okiLines.length > 0) {
            tree.innerHTML = okiLines.map(line => `
                <div class="tactic-btn">
                    <span class="tactic-arrow">➜</span>
                    <span>${line}</span>
                </div>
            `).join('');
        } else {
            tree.innerHTML = `<div class="text-gray-500 text-center text-xl">無後續設定</div>`;
        }

        overlay.style.display = 'flex';
        setTimeout(() => { overlay.classList.add('show'); }, 10);
    };

    window.closeFocus = function() {
        const overlay = document.getElementById('focusOverlay');
        overlay.classList.remove('show');
        setTimeout(() => { overlay.style.display = 'none'; }, 220);
    };

    window.deleteCard = async function(event, id) {
        event.stopPropagation();
        if (!confirm("確定刪除？")) return;

        const note = allNotes.find(n => n.id === id);
        if (!note) return;

        // 先更新畫面
        allNotes = allNotes.filter(n => n.id !== id);
        renderNotes();

        // 再刪雲端
        if (note.docId) {
            try {
                await deleteDoc(doc(db, "notes", note.docId));
            } catch (e) {
                console.error("刪除雲端失敗", e);
            }
        }
    };

    window.toggleBuilder = function() {
        const builder = document.getElementById('builderSection');
        const btn = document.getElementById('addBtn');
        if (builder.classList.contains('hidden')) { 
            builder.classList.remove('hidden'); 
            btn.classList.add('hidden'); 
            stepInput.focus(); 
        } else { 
            builder.classList.add('hidden'); 
            btn.classList.remove('hidden'); 
        }
    };

    // ===== 初始化與事件綁定 =====
    renderCharGrid(characters);
    renderPreview();

    stepInput.addEventListener('input', function() { this.value = this.value.toUpperCase(); });
    stepInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && this.value.trim() !== "") {
            currentSteps.push(this.value.trim().toUpperCase());
            this.value = ""; 
            renderPreview();
        }
    });

    saveBtn.addEventListener('click', async function() {
        if (currentSteps.length === 0) {
            alert("請輸入連段！");
            return;
        }
        const note = {
            id: Date.now(),
            char: currentCharacter,
            steps: [...currentSteps],
            okiRaw: document.getElementById('okiInput').value,
            frame: document.getElementById('frameInput').value || "?",
            dmg: document.getElementById('dmgInput').value || "0",
            type: document.getElementById('tagSelect').value,
            drive: document.getElementById('driveSelect').value
        };

        // 先更新本機資料 + 畫面
        allNotes.push(note);
        renderNotes();

        // 清 input + 收起 Builder
        currentSteps = [];
        stepInput.value = "";
        document.getElementById('okiInput').value = "";
        document.getElementById('dmgInput').value = "";
        document.getElementById('frameInput').value = "";
        renderPreview();
        toggleBuilder();

        // 再 async 丟到雲端
        try {
            const docId = await saveCardToCloud(note);
            note.docId = docId;
        } catch (e) {
            console.error("儲存到雲端失敗", e);
        }
    });
</script>
